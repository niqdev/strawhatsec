#include <stdio.h>
#include <stdlib.h>

static void cleanup(void) __attribute__ ((destructor));

main() {
  printf("Some actions happen in the main() function..\n");
  printf("and then when main() exits, the destructor is called..\n");

  exit(0);
}

void cleanup(void) {
  printf("In the cleanup function now..\n");
}

/*

* In binary programs compiled with the GNU C compiler, special table sections
  called .dtors and .ctors are made for destructors and constructors, respectively.
* Constructor functions are executed before the main() function is executed,
  and destructor functions are executed just before the main() function exits with an exit system call.
* This behavior of automatically executing a function on exit is controlled by the .dtors table section of the binary.
* This section is an array of 32-bit addresses terminated by a NULL address.
  The array always begins with 0xffffffff and ends with the NULL address of 0x00000000.
  Between these two are the addresses of all the functions that have been declared with the destructor attribute.

OUTPUT

./dtors_sample.out
Some actions happen in the main() function..
and then when main() exits, the destructor is called..
In the cleanup function now..

gcc -g dtors_sample.c -o dtors_sample.out
00001edc d _DYNAMIC
00001fd4 d _GLOBAL_OFFSET_TABLE_
0000065c R _IO_stdin_used
         w _ITM_deregisterTMCloneTable
         w _ITM_registerTMCloneTable
0000083c r __FRAME_END__
000006e8 r __GNU_EH_FRAME_HDR
00002008 D __TMC_END__
00002008 B __bss_start
         w __cxa_finalize@@GLIBC_2.1.3
00002000 D __data_start
00000500 t __do_global_dtors_aux
00001ed4 t __do_global_dtors_aux_fini_array_entry
00002004 D __dso_handle
00001ed0 t __frame_dummy_init_array_entry
         w __gmon_start__
00001ed4 t __init_array_end
00001ed0 t __init_array_start
00000640 T __libc_csu_fini
000005e0 T __libc_csu_init
         U __libc_start_main@@GLIBC_2.0
000005d0 T __x86.get_pc_thunk.ax
00000460 T __x86.get_pc_thunk.bx
00000559 T __x86.get_pc_thunk.dx
00002008 D _edata
0000200c B _end
00000644 T _fini
00000658 R _fp_hw
000003a0 T _init
00000420 T _start
000005a5 t cleanup
00002008 b completed.7283
00002000 W data_start
00000470 t deregister_tm_clones
         U exit@@GLIBC_2.0
00000550 t frame_dummy
0000055d T main
         U puts@@GLIBC_2.0
000004b0 t register_tm_clones

gcc -g -m32 -fno-stack-protector -z execstack -fno-pie -no-pie dtors_sample.c -o dtors_sample.out
nm ./dtors_sample.out 
08049f14 d _DYNAMIC
0804a000 d _GLOBAL_OFFSET_TABLE_
0804852c R _IO_stdin_used
08048704 r __FRAME_END__
080485b8 r __GNU_EH_FRAME_HDR
0804a020 D __TMC_END__
0804a020 B __bss_start
0804a018 D __data_start
08048420 t __do_global_dtors_aux
08049f0c t __do_global_dtors_aux_fini_array_entry
0804a01c D __dso_handle
08049f08 t __frame_dummy_init_array_entry
         w __gmon_start__
08049f0c t __init_array_end
08049f08 t __init_array_start
08048510 T __libc_csu_fini
080484b0 T __libc_csu_init
         U __libc_start_main@@GLIBC_2.0
08048390 T __x86.get_pc_thunk.bx
08048380 T _dl_relocate_static_pie
0804a020 D _edata
0804a024 B _end
08048514 T _fini
08048528 R _fp_hw
080482c8 T _init
08048340 T _start
08048491 t cleanup
0804a020 b completed.7283
0804a018 W data_start
080483a0 t deregister_tm_clones
         U exit@@GLIBC_2.0
08048450 t frame_dummy
08048456 T main
         U puts@@GLIBC_2.0
080483e0 t register_tm_clones

objdump -x ./dtors_sample.out

>>> obsolete
* __DTOR_END__ and __DTOR_LIST__ are missing
* replaced by __init_array_end and __init_array_start
https://stackoverflow.com/questions/31893194/when-i-use-gnu-nm-it-doesnt-display-dtor-list

*/
