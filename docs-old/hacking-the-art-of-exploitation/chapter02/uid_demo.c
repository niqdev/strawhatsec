#include <stdio.h>

// gcc -g uid_demo.c -o uid_demo.out
int main() {
  printf("real uid: %d\n", getuid());
  printf("effective uid: %d\n", geteuid());
}

/*

Each permission corresponds to a bit flag:
- read is 4 (100 in binary)
- write is 2 (010 in binary)
- execute is 1 (001 in binary)
- since each value only contains unique bits, a bitwise OR operation achieves the same result as adding these numbers together does
- switch user `sudo su <USER>`
- the command `chsh` allows any user to change his or her own login shell

There are many times when multiple users need to be able to access certain portions of the same file.
For example, the `/etc/passwd` file contains account information for every user on the system,
including each user's default login shell.
The command `chsh` allows any user to change his or her own login shell.
This program needs to be able to make changes to the `/etc/passwd` file, but
only on the line that pertains to the current user's account.
The solution to this problem in Unix is the "set user ID" (setuid) permission.
This is an additional file permission bit that can be set using chmod.
When a program with this flag is executed, it runs as the user ID of the file's owner.

# id 
uid=0(root) gid=0(root) groups=0(root)
# which chsh
/usr/bin/chsh
# ls -l /usr/bin/chsh /etc/passwd
-rw-r--r-- 1 root root   926 Jan  5 19:27 /etc/passwd
-rwsr-xr-x 1 root root 43684 Mar 22  2019 /usr/bin/chsh
^^^ s is setuid

- The chsh program has the setuid flag set, which is indicated by an `s` in the ls output above.
- Since this file is owned by root and has the setuid permission set,
  the program will run as the root user when any user runs this program.
- The /etc/passwd file that chsh writes to is also owned by root and only allows the owner to write to it.
- The program logic in chsh is designed to only allow writing to the line in /etc/passwd that corresponds to the user running the program,
  even though the program is effectively running as root
- This means that a running program has both a real user ID and an effective user ID.
  These IDs can be retrieved using the functions getuid() and geteuid()

EXAMPLE

# build with root (inside container)
gcc -g uid_demo.c -o uid_demo.out

# verify user id
./uid_demo.out 
real uid: 0
effective uid: 0

# (outside container)

./uid_demo.out 
real uid: 1000
effective uid: 1000

ls -la uid_demo.out 
-rwxr-xr-x 1 root root 9604 Feb 18 09:21 uid_demo.out

chmod u+s uid_demo.out 
chmod: changing permissions of 'uid_demo.out': Operation not permitted

sudo chmod u+s uid_demo.out 

# note the setuid flag
ls -la uid_demo.out 
-rwsr-xr-x 1 root root 9604 Feb 18 09:21 uid_demo.out
^^^ setuid

# user runs program as root
./uid_demo.out 
real uid: 1000
effective uid: 0

*/
