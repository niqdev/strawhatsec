#include <stdio.h>
#include <string.h>

// gcc -g overflow_example.c -o overflow_example.out
// 
int main(int argc, char *argv[]) {
  int value = 5;
  char buffer_one[8], buffer_two[8];

  strcpy(buffer_one, "one"); /* Put "one" into buffer_one. */
  strcpy(buffer_two, "two"); /* Put "two" into buffer_two. */

  printf("[BEFORE] buffer_two is at %p and contains \'%s\'\n", buffer_two, buffer_two);
  printf("[BEFORE] buffer_one is at %p and contains \'%s\'\n", buffer_one, buffer_one);
  printf("[BEFORE] value is at %p and is %d (0x%08x)\n", &value, value, value);

  printf("\n[STRCPY] copying %d bytes into buffer_two\n\n", strlen(argv[1]));
  strcpy(buffer_two, argv[1]); /* Copy first argument into buffer_two. */

  printf("[AFTER] buffer_two is at %p and contains \'%s\'\n", buffer_two, buffer_two);
  printf("[AFTER] buffer_one is at %p and contains \'%s\'\n", buffer_one, buffer_one);
  printf("[AFTER] value is at %p and is %d (0x%08x)\n", &value, value, value);
}

/*

OUTPUT

# default compilation flags
gcc -g overflow_example.c -o overflow_example.out

# no parameters
./overflow_example.out 
[BEFORE] buffer_two is at 0xffd35e44 and contains 'two'
[BEFORE] buffer_one is at 0xffd35e3c and contains 'one'
[BEFORE] value is at 0xffd35e38 and is 5 (0x00000005)
Segmentation fault (core dumped)

./overflow_example.out 1234567890
[BEFORE] buffer_two is at 0xffb36c74 and contains 'two'
[BEFORE] buffer_one is at 0xffb36c6c and contains 'one'
[BEFORE] value is at 0xffb36c68 and is 5 (0x00000005)

[STRCPY] copying 10 bytes into buffer_two

[AFTER] buffer_two is at 0xffb36c74 and contains '1234567890'
[AFTER] buffer_one is at 0xffb36c6c and contains 'one'
[AFTER] value is at 0xffb36c68 and is 5 (0x00000005)
*** stack smashing detected ***: <unknown> terminated
Aborted (core dumped)

# disable protections
gcc -g -m32 -fno-stack-protector -z execstack -fno-pie -no-pie overflow_example.c -o overflow_example.out

./overflow_example.out 1234567890
[BEFORE] buffer_two is at 0xff9d245c and contains 'two'
[BEFORE] buffer_one is at 0xff9d2464 and contains 'one'
[BEFORE] value is at 0xff9d246c and is 5 (0x00000005)

[STRCPY] copying 10 bytes into buffer_two

[AFTER] buffer_two is at 0xff9d245c and contains '1234567890'
[AFTER] buffer_one is at 0xff9d2464 and contains '90'
[AFTER] value is at 0xff9d246c and is 5 (0x00000005)

^^^ Notice that buffer_one is located directly after buffer_two in memory, so when ten bytes are copied into buffer_two,
the last two bytes of 90 overflow into buffer_one and overwrite whatever was there

./overflow_example.out AAAAAAAAAAAAAAAAABCD
[BEFORE] buffer_two is at 0xffa7f27c and contains 'two'
[BEFORE] buffer_one is at 0xffa7f284 and contains 'one'
[BEFORE] value is at 0xffa7f28c and is 5 (0x00000005)

[STRCPY] copying 20 bytes into buffer_two

[AFTER] buffer_two is at 0xffa7f27c and contains 'AAAAAAAAAAAAAAAAABCD'
[AFTER] buffer_one is at 0xffa7f284 and contains 'AAAAAAAAABCD'
[AFTER] value is at 0xffa7f28c and is 1145258561 (0x44434241)

*/
