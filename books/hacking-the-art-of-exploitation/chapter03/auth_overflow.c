#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int check_authentication(char *password) {
  // reversing the order of the declaration will not override the return type
  int auth_flag = 0;
  char password_buffer[16];

  strcpy(password_buffer, password);

  if (strcmp(password_buffer, "brillig") == 0)
    auth_flag = 1;
  if (strcmp(password_buffer, "outgrabe") == 0)
    auth_flag = 1;

  return auth_flag;
}


int main(int argc, char *argv[]) {
  if (argc < 2) {
    printf("Usage: %s <password>\n", argv[0]);
    exit(0);
  }

  // considers any nonzero value to be authenticated
  if (check_authentication(argv[1])) {
    printf("\n-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
    printf("\tAccess Granted.\n");
    printf("-=-=-=-=-=-=-=-=-=-=-=-=-=-\n");
  } else {
    printf("\nAccess Denied.\n");
  }
}

/*

gcc -g -m32 -fno-stack-protector -z execstack -fno-pie -no-pie -z norelro auth_overflow.c -o auth_overflow.out

./auth_overflow.out brillig
./auth_overflow.out outgrabe

# no segmentation fault (x27)
./auth_overflow.out AAAAAAAAAAAAAAAAAAAAAAAAAAA

# x30
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

gdb -q auth_overflow.out
break 9
break 16

(gdb) run AAAAAAAAAAAAAAAAAAAAAAAAAAA
(gdb) x/s password_buffer
0xffeca9bc:	"\bh\372\367"
(gdb) x/x &auth_flag
0xffeca9cc:	0x00
(gdb) print 0xffeca9cc - 0xffeca9bc
$1 = 16

(gdb) x/16xw password_buffer
0xffeca9bc:	0xf7fa6808	0xf7fa3000	0xf7fa3000	0x00000000
0xffeca9cc:	0x00000000	0xf7fa33fc	0x00000000	0xffeca9f8
0xffeca9dc:	0x08048571	0xffecc915	0xffecaaa4	0xffecaab0
0xffeca9ec:	0x080485f1	0xf7fc2970	0xffecaa10	0x00000000

(gdb) continue

(gdb) x/s password_buffer
0xffeca9bc:	'A' <repeats 27 times>
(gdb) x/x &auth_flag
0xffeca9cc:	0x41
(gdb) x/16xw password_buffer
0xffeca9bc:	0x41414141	0x41414141	0x41414141	0x41414141
0xffeca9cc:	0x41414141	0x41414141	0x00414141	0xffeca9f8
0xffeca9dc:	0x08048571	0xffecc915	0xffecaaa4	0xffecaab0
0xffeca9ec:	0x080485f1	0xf7fc2970	0xffecaa10	0x00000000

(gdb) x/4cb &auth_flag
0xffeca9cc:	65 'A'	65 'A'	65 'A'	65 'A'
(gdb) x/dw &auth_flag
0xffeca9cc:	1094795585

(gdb) continue 
Continuing.

-=-=-=-=-=-=-=-=-=-=-=-=-=-
	Access Granted.
-=-=-=-=-=-=-=-=-=-=-=-=-=-

*/
